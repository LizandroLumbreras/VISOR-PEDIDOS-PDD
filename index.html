<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>üìã Ver y Editar Pedidos</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f4f4f4; }
    h1 { text-align: center; margin-bottom: 20px; }
    .card {
      background: #fff; padding: 15px; border-radius: 10px;
      margin: 10px 0; box-shadow: 0 2px 6px rgba(0,0,0,.2);
    }
    .productos { margin-left: 20px; color: #333; }
    .productos li { margin-bottom: 5px; }
    .header { font-weight: bold; margin-bottom: 6px; }
    .editarForm { margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 6px; display: none; }
    .editarForm input, .editarForm select {
      margin: 4px 0; padding: 6px; width: 100%;
    }
    .editarForm button {
      margin-top: 5px; background: #28a745; color: #fff;
      border: none; padding: 8px; border-radius: 6px; cursor: pointer;
    }
    .btnEditar {
      background: #007bff; color: white; border: none;
      padding: 6px 10px; border-radius: 6px; cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>üìã Pedidos Realizados</h1>
  <div id="listaPedidos"></div>

  <script>
    // üîπ Conexi√≥n a Supabase
    const supabase = window.supabase.createClient(
      "https://cvpbtjlupswbyxenugpz.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN2cGJ0amx1cHN3Ynl4ZW51Z3B6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc3MDIxOTQsImV4cCI6MjA2MzI3ODE5NH0.iiJsYM3TtaGPdeCtPcEXwAz3LfFc1uJGECEvOErvrqY"
    );

    async function cargarPedidos() {
      const { data: pedidos, error } = await supabase
        .from("pedidos")
        .select("*")
        .order("folio", { ascending: false });

      if (error) {
        alert("Error al cargar pedidos: " + error.message);
        return;
      }

      const lista = document.getElementById("listaPedidos");
      lista.innerHTML = "";

      for (let p of pedidos) {
        const { data: detalles } = await supabase
          .from("pedido_detalles")
          .select("*")
          .eq("pedido_id", p.folio);

        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="header">Pedido #${p.folio} ‚Äì Cliente: ${p.cliente}</div>
          <p><b>Fecha:</b> ${new Date(p.fecha).toLocaleString()}</p>
          <p><b>Cantidad global:</b> ${p.cantidad}</p>
          <p><b>Total:</b> $${p.total}</p>
          <p><b>Forma de pago:</b> ${p.pago}</p>
          <p><b>Chofer:</b> ${p.chofer}</p>
          <p><b>Dato libre:</b> ${p.libre || "-"}</p>
          <p><b>Productos:</b></p>
          <ul class="productos">
            ${detalles && detalles.length > 0
              ? detalles.map(d => `<li>${d.cantidad} √ó ${d.producto}</li>`).join("")
              : "<li>Sin productos</li>"
            }
          </ul>
          <button class="btnEditar" onclick="mostrarEdicion(${p.folio})">‚úèÔ∏è Editar</button>
          <form id="form-${p.folio}" class="editarForm" onsubmit="guardarEdicion(event, ${p.folio})">
            <input type="number" step="0.01" name="cantidad" placeholder="Cantidad global" value="${p.cantidad}">
            <input type="number" step="0.01" name="total" placeholder="Total" value="${p.total}">
            <select name="pago">
              <option value="pendiente" ${p.pago === "pendiente" ? "selected" : ""}>pendiente</option>
              <option value="efectivo" ${p.pago === "efectivo" ? "selected" : ""}>efectivo</option>
              <option value="tarjeta" ${p.pago === "tarjeta" ? "selected" : ""}>tarjeta</option>
              <option value="transferencia" ${p.pago === "transferencia" ? "selected" : ""}>transferencia</option>
              <option value="remision" ${p.pago === "remision" ? "selected" : ""}>remision</option>
              <option value="factura" ${p.pago === "factura" ? "selected" : ""}>factura</option>
              <option value="credito" ${p.pago === "credito" ? "selected" : ""}>credito</option>
            </select>
            <select name="chofer">
              <option value="pendiente" ${p.chofer === "pendiente" ? "selected" : ""}>pendiente</option>
              <option value="pedro damian elizondo irachetay" ${p.chofer === "pedro damian elizondo irachetay" ? "selected" : ""}>pedro damian elizondo irachetay</option>
              <option value="sergio becerra maravilla" ${p.chofer === "sergio becerra maravilla" ? "selected" : ""}>sergio becerra maravilla</option>
            </select>
            <input type="text" name="libre" placeholder="Dato libre" value="${p.libre || ""}">
            <button type="submit">üíæ Guardar cambios</button>
          </form>
        `;
        lista.appendChild(card);
      }
    }

    // Mostrar formulario de edici√≥n
    function mostrarEdicion(folio) {
      const form = document.getElementById(`form-${folio}`);
      form.style.display = form.style.display === "none" ? "block" : "none";
    }

    // Guardar cambios en Supabase
    async function guardarEdicion(e, folio) {
      e.preventDefault();
      const form = e.target;

      const cantidad = parseFloat(form.cantidad.value) || 0;
      const total = parseFloat(form.total.value) || 0;
      const pago = form.pago.value;
      const chofer = form.chofer.value;
      const libre = form.libre.value;

      const { error } = await supabase.from("pedidos")
        .update({ cantidad, total, pago, chofer, libre })
        .eq("folio", folio);

      if (error) {
        alert("‚ùå Error al actualizar: " + error.message);
      } else {
        alert("‚úÖ Pedido actualizado");
        cargarPedidos();
      }
    }

    cargarPedidos();
  </script>
</body>
</html>
